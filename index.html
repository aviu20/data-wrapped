<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Wrapped - Your Dating Story</title>
    <meta property="og:title" content="Data Wrapped - Discover Your Dating Story">
    <meta property="og:description" content="Upload your Hinge data and get a Spotify Wrapped-style summary!">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’•</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;
        
        const Icons = {
            Upload: ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Heart: ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>,
            Flame: ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>,
            MessageCircle: ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>,
            Sparkles: ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
            TrendingUp: ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            Clock: ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Zap: ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            User: ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        };

        function App() {
            const [analysis, setAnalysis] = useState(null);
            const [loading, setLoading] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState('');
            const [currentSlide, setCurrentSlide] = useState(0);

            const analyzeData = async (data) => {
                let likes = [], matches = [], allChatMessages = [], allItems = [];
                
                if (Array.isArray(data)) {
                    allItems = data;
                    likes = data.filter(item => item.like && Array.isArray(item.like));
                    matches = data.filter(item => item.match && Array.isArray(item.match));
                    data.forEach(item => {
                        if (item.chats && Array.isArray(item.chats)) {
                            item.chats.forEach(chat => {
                                if (chat.body) allChatMessages.push({text: chat.body, timestamp: chat.timestamp});
                            });
                        }
                    });
                }

                const totalLikes = likes.length;
                const totalMatches = matches.length;
                const likeToMatchRate = totalLikes > 0 ? ((totalMatches / totalLikes) * 100).toFixed(1) : 0;

                const activityByHour = {}, activityByDay = {};
                const allTimestamps = [];
                
                likes.forEach(item => item.like && item.like.forEach(l => l.timestamp && allTimestamps.push(l.timestamp)));
                matches.forEach(item => item.match && item.match.forEach(m => m.timestamp && allTimestamps.push(m.timestamp)));
                allChatMessages.forEach(msg => msg.timestamp && allTimestamps.push(msg.timestamp));
                
                allTimestamps.forEach(ts => {
                    const date = new Date(ts);
                    if (!isNaN(date.getTime())) {
                        const day = date.toLocaleDateString('en-US', {weekday: 'short'});
                        const hour = date.getHours();
                        activityByDay[day] = (activityByDay[day] || 0) + 1;
                        activityByHour[hour] = (activityByHour[hour] || 0) + 1;
                    }
                });

                const peakDay = Object.entries(activityByDay).sort((a,b) => b[1] - a[1])[0];
                const peakHour = Object.entries(activityByHour).sort((a,b) => b[1] - a[1])[0];

                const conversationsWithChats = allItems.filter(item => item.chats && item.chats.length > 0);
                const avgConversationLength = conversationsWithChats.length > 0 
                    ? (conversationsWithChats.reduce((sum, item) => sum + item.chats.length, 0) / conversationsWithChats.length).toFixed(1)
                    : 0;

                let messagingAnalysis = null;
                if (allChatMessages.length > 0) {
                    const sampleMessages = allChatMessages.map(m => m.text).filter(Boolean).slice(0, 40);
                    console.log('Analyzing', sampleMessages.length, 'messages');
                    
                    // Update loading message if we're in the upload flow
                    if (typeof setLoadingMessage === 'function') {
                        setLoadingMessage('AI is analyzing your texting style... ğŸ¤–');
                    }
                    
                    try {
                        const response = await fetch("https://api.anthropic.com/v1/messages", {
                            method: "POST",
                            headers: {"Content-Type": "application/json"},
                            body: JSON.stringify({
                                model: "claude-sonnet-4-20250514",
                                max_tokens: 1500,
                                messages: [{
                                    role: "user",
                                    content: `You are analyzing dating app messages. Based on these messages from a single person, create a personality profile.

Messages: ${JSON.stringify(sampleMessages)}

Respond with ONLY a JSON object in this exact format (no markdown, no extra text):
{
  "flirtScore": 7,
  "flirtStyle": "playful",
  "messageStyle": "witty",
  "userPersonalityTraits": ["Curious", "Adventurous", "Thoughtful", "Funny", "Ambitious"],
  "dateabilityScore": 8,
  "dateabilityRoast": "Texts back fast but might ghost if the vibe isn't there",
  "quirkyInsight": "Uses way too many emojis when excited",
  "signatureLine": "So what's your story?",
  "topUsedWords": ["haha", "actually", "love"]
}`
                                }]
                            })
                        });
                        const result = await response.json();
                        console.log('API Response:', result);
                        
                        if (result.content && result.content.length > 0) {
                            const text = result.content.filter(i => i.type === 'text').map(i => i.text).join('');
                            console.log('Raw text:', text);
                            const cleaned = text.replace(/```json|```/g, '').trim();
                            messagingAnalysis = JSON.parse(cleaned);
                            console.log('Parsed analysis:', messagingAnalysis);
                        } else if (result.error) {
                            console.error('API Error:', result.error);
                        }
                    } catch (e) { 
                        console.error('Analysis error:', e);
                        console.error('Error details:', e.message);
                    }
                } else {
                    console.log('No chat messages found to analyze');
                }

                return {
                    basicStats: {totalLikes, totalMatches, totalConversations: conversationsWithChats.length, likeToMatchRate, totalMessages: allChatMessages.length, avgConversationLength},
                    patterns: {peakDay: peakDay ? peakDay[0] : 'Unknown', peakHour: peakHour ? parseInt(peakHour[0]) : null},
                    messagingAnalysis
                };
            };

            const handleUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setLoading(true);
                setLoadingMessage('Reading your file...');
                setAnalysis(null);
                setCurrentSlide(0);
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    setLoadingMessage('Analyzing your data...');
                    const results = await analyzeData(data);
                    setAnalysis(results);
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setLoading(false);
                    setLoadingMessage('');
                }
            };

            const getQuip = (stat, val) => {
                if (stat === 'likes') return val > 100 ? "Someone's been busy! ğŸ‘€" : val > 50 ? "Quality over quantity... right? ğŸ˜…" : "Selective king/queen ğŸ‘‘";
                if (stat === 'matchRate') return val > 20 ? "Main character energy âœ¨" : val > 10 ? "Doing better than most! ğŸ¯" : "Quality over quantity gang ğŸ’";
                if (stat === 'conversations') return val > 50 ? "Professional yapper ğŸ—£ï¸" : val > 20 ? "Social butterfly mode ğŸ¦‹" : "Mysterious and selective ğŸŒ™";
                if (stat === 'avgMessages') return val > 30 ? "Essay writer detected ğŸ“š" : val > 15 ? "Actually trying! ğŸ’¬" : "Efficiency expert ğŸ¯";
                return "Iconic behavior ğŸ’…";
            };

            const formatTime = (hour) => {
                if (hour === null) return 'Unknown';
                const period = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour > 12 ? hour - 12 : hour === 0 ? 12 : hour;
                return `${displayHour}${period}`;
            };

            if (!analysis) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-8 bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50">
                        <div className="bg-white rounded-3xl shadow-2xl p-12 text-center max-w-lg w-full">
                            <Icons.Sparkles className="w-20 h-20 text-purple-600 mx-auto mb-6 animate-pulse" />
                            <h1 className="text-4xl font-bold mb-4 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Data Wrapped</h1>
                            <p className="text-gray-600 mb-8 text-lg">Upload your Hinge data to see your year in review ğŸ“Šâœ¨</p>
                            <label className="cursor-pointer">
                                <input type="file" accept=".json" onChange={handleUpload} className="hidden" />
                                <div className="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-4 rounded-full font-bold text-lg hover:shadow-xl transition-all transform hover:scale-105 inline-block">
                                    Upload Your Data
                                </div>
                            </label>
                            {loading && <p className="mt-6 text-purple-600 animate-pulse font-semibold">{loadingMessage || 'Analyzing your love life... ğŸ’•'}</p>}
                            <p className="text-xs text-gray-400 mt-8">All data processed locally ğŸ”’</p>
                        </div>
                    </div>
                );
            }

            const slides = [
                {bg: 'from-purple-600 to-pink-600', content: <div className="text-center text-white space-y-6"><Icons.Sparkles className="w-20 h-20 mx-auto animate-pulse" /><h1 className="text-6xl font-bold">Your Hinge</h1><h1 className="text-6xl font-bold">Wrapped</h1><p className="text-2xl opacity-90 pt-4">Let's see what you've been up to... ğŸ‘€</p></div>},
                {bg: 'from-rose-500 to-orange-500', content: <div className="text-center text-white space-y-8"><Icons.Heart className="w-16 h-16 mx-auto" /><div><p className="text-2xl mb-4">You sent</p><p className="text-8xl font-bold">{analysis.basicStats.totalLikes}</p><p className="text-3xl mt-4">likes this year</p></div><p className="text-xl opacity-90 pt-4">{getQuip('likes', analysis.basicStats.totalLikes)}</p></div>},
                {bg: 'from-pink-600 to-purple-600', content: <div className="text-center text-white space-y-8"><Icons.TrendingUp className="w-16 h-16 mx-auto" /><div><p className="text-2xl mb-4">Match rate</p><p className="text-8xl font-bold">{analysis.basicStats.likeToMatchRate}%</p><p className="text-xl mt-4 opacity-80">{analysis.basicStats.totalMatches} matches</p></div><p className="text-xl opacity-90 pt-4">{getQuip('matchRate', parseFloat(analysis.basicStats.likeToMatchRate))}</p></div>},
                {bg: 'from-blue-600 to-purple-600', content: <div className="text-center text-white space-y-8"><Icons.MessageCircle className="w-16 h-16 mx-auto" /><div><p className="text-2xl mb-4">You started</p><p className="text-8xl font-bold">{analysis.basicStats.totalConversations}</p><p className="text-3xl mt-4">conversations</p></div><p className="text-xl opacity-90 pt-4">{getQuip('conversations', analysis.basicStats.totalConversations)}</p></div>},
                {bg: 'from-indigo-600 to-blue-600', content: <div className="text-center text-white space-y-8"><Icons.Zap className="w-16 h-16 mx-auto" /><div><p className="text-2xl mb-4">Average conversation</p><p className="text-8xl font-bold">{analysis.basicStats.avgConversationLength}</p><p className="text-3xl mt-4">messages</p></div><p className="text-xl opacity-90 pt-4">{getQuip('avgMessages', parseFloat(analysis.basicStats.avgConversationLength))}</p></div>},
                {bg: 'from-violet-600 to-purple-600', content: <div className="text-center text-white space-y-8"><Icons.Clock className="w-16 h-16 mx-auto" /><div><p className="text-2xl mb-4">Most active at</p><p className="text-8xl font-bold">{formatTime(analysis.patterns.peakHour)}</p><p className="text-xl mt-4 opacity-80">on {analysis.patterns.peakDay}s</p></div></div>}
            ];

            if (analysis.messagingAnalysis) {
                slides.push(
                    {bg: 'from-red-500 to-pink-600', content: <div className="text-center text-white space-y-8"><Icons.Flame className="w-16 h-16 mx-auto animate-pulse" /><div><p className="text-2xl mb-4">Flirt Score</p><p className="text-8xl font-bold">{analysis.messagingAnalysis.flirtScore}/10</p><p className="text-3xl mt-4 capitalize">{analysis.messagingAnalysis.flirtStyle}</p></div></div>},
                    {bg: 'from-orange-500 to-red-500', content: <div className="text-center text-white space-y-8"><Icons.MessageCircle className="w-16 h-16 mx-auto" /><div><p className="text-2xl mb-4">Your texting vibe</p><p className="text-6xl font-bold capitalize">{analysis.messagingAnalysis.messageStyle}</p></div><p className="text-xl opacity-90 pt-6 px-8">{analysis.messagingAnalysis.quirkyInsight}</p></div>},
                    {bg: 'from-yellow-500 to-orange-500', content: <div className="text-center text-white space-y-8 px-8"><Icons.Sparkles className="w-16 h-16 mx-auto" /><p className="text-2xl mb-6">Your go-to line</p><div className="bg-white/20 backdrop-blur rounded-2xl p-8"><p className="text-3xl font-bold italic">"{analysis.messagingAnalysis.signatureLine}"</p></div></div>},
                    {bg: 'from-purple-600 to-indigo-600', content: <div className="text-center text-white space-y-6 px-8"><Icons.User className="w-16 h-16 mx-auto" /><p className="text-3xl font-bold mb-8">You Are...</p><div className="space-y-4">{analysis.messagingAnalysis.userPersonalityTraits.map((t, i) => <div key={i} className="text-2xl font-semibold bg-white/20 rounded-full py-3 px-6 backdrop-blur">{t}</div>)}</div></div>},
                    {bg: 'from-green-500 to-emerald-600', content: <div className="text-center text-white space-y-8"><Icons.Heart className="w-16 h-16 mx-auto animate-pulse" /><div><p className="text-2xl mb-4">Dateability Score</p><p className="text-8xl font-bold">{analysis.messagingAnalysis.dateabilityScore}/10</p><div className="mt-6 px-8"><div className="bg-white/20 backdrop-blur rounded-xl p-4"><p className="text-lg italic">{analysis.messagingAnalysis.dateabilityRoast}</p></div></div></div></div>}
                );
            }

            slides.push({bg: 'from-pink-600 to-purple-600', content: <div className="text-center text-white space-y-8"><Icons.Heart className="w-20 h-20 mx-auto" /><div><p className="text-4xl font-bold mb-6">That's a wrap!</p><p className="text-xl opacity-90 px-8">{analysis.basicStats.totalMatches > 10 ? "You're doing great! âœ¨" : "Quality over quantity ğŸ’"}</p></div><div className="pt-8 text-sm opacity-75"><p>#HingeWrapped #DataWrapped</p></div></div>});

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50">
                    <div className="w-full max-w-md">
                        <div className={`aspect-[9/16] bg-gradient-to-br ${slides[currentSlide].bg} rounded-3xl shadow-2xl p-12 flex flex-col justify-center relative`}>
                            {slides[currentSlide].content}
                            <div className="absolute top-6 left-0 right-0 flex justify-center gap-2 px-6">
                                {slides.map((_, i) => <div key={i} className={`h-1 flex-1 rounded-full ${i === currentSlide ? 'bg-white' : 'bg-white/30'}`} />)}
                            </div>
                            <div className="absolute bottom-6 right-6 text-white/60 text-sm">DataWrapped</div>
                        </div>
                        <div className="flex gap-4 mt-6 justify-center">
                            <button onClick={() => setCurrentSlide(Math.max(0, currentSlide - 1))} disabled={currentSlide === 0} className="px-6 py-3 bg-white rounded-full font-semibold shadow-lg disabled:opacity-50 hover:shadow-xl transition-all">â† Previous</button>
                            <button onClick={() => setCurrentSlide(Math.min(slides.length - 1, currentSlide + 1))} disabled={currentSlide === slides.length - 1} className="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-full font-semibold shadow-lg disabled:opacity-50 hover:shadow-xl transition-all">Next â†’</button>
                        </div>
                        <p className="text-center mt-6 text-gray-600 text-sm">ğŸ“¸ Screenshot to share!</p>
                        <button onClick={() => setAnalysis(null)} className="mt-6 w-full py-3 bg-gray-200 text-gray-700 rounded-full font-semibold hover:bg-gray-300">Analyze Another File</button>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
